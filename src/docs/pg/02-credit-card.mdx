import { FeatureGrid, TestScenario, ErrorGuide, NextSteps, DocumentFooter } from '../../components'

# 💳 신용카드 결제

가장 널리 사용되는 결제 수단인 신용카드 결제 서비스입니다. 국내외 주요 카드사를 지원하며, 안전하고 빠른 결제를 제공합니다.

## 📖 개요

### 🎯 주요 특징

<FeatureGrid features={[
  {
    icon: "💳",
    title: "다양한 카드사",
    description: "국내외 주요 카드사 지원, 넓은 가맹점 네트워크",
    bgColor: "from-hecto-50 to-hecto-100",
    borderColor: "border-hecto-200",
    iconBgColor: "bg-hecto-400"
  },
  {
    icon: "🔒",
    title: "3D Secure",
    description: "안전한 인증 시스템으로 보안 강화",
    bgColor: "from-slate-50 to-slate-100",
    borderColor: "border-slate-200",
    iconBgColor: "bg-slate-600"
  },
  {
    icon: "📅",
    title: "할부 결제",
    description: "다양한 할부 옵션으로 고객 편의성 제공",
    bgColor: "from-emerald-50 to-emerald-100",
    borderColor: "border-emerald-200",
    iconBgColor: "bg-emerald-500"
  },
  {
    icon: "🔄",
    title: "정기 결제",
    description: "빌키 서비스로 편리한 정기 결제 관리",
    bgColor: "from-violet-50 to-violet-100",
    borderColor: "border-violet-200",
    iconBgColor: "bg-violet-500"
  }
]} />

### 💳 지원 카드사

<div className="overflow-x-auto">

| 카드사 | 코드 | 특징 |
|--------|------|------|
| **국민카드** | `KBC` | 앱카드, 간편결제 지원 |
| **신한카드** | `SHN` | 앱카드, 간편결제 지원 |
| **삼성카드** | `SSC` | 앱카드, 삼성페이 연동 |
| **현대카드** | `HDC` | PayShot, 앱카드 지원 |
| **하나카드** | `HNC` | 외환카드 통합 |
| **우리카드** | `WRI` | 광범위한 가맹점 네트워크 |
| **롯데카드** | `LTC` | 포인트 적립 서비스 |
| **BC카드** | `BCC` | 다양한 제휴 카드 |
| **NH농협** | `NHC` | 체크카드 포함 |

</div>

---

## ⚡ 빠른 시작

### 1️⃣ 기본 결제창 연동

```html
<!-- 헥토파이낸셜 SDK 로드 -->
<script src="https://tbnpg.settlebank.co.kr/resources/js/v1/SettlePG_v1.2.js"></script>

<script>
// 신용카드 결제 요청
SETTLE_PG.pay({
    env: "https://tbnpg.settlebank.co.kr",
    mchtId: "nxca_jt_il",           // 상점 ID (인증)
    method: "card",                 // 신용카드 결제
    trdDt: "20231215",              // 거래일자
    trdTm: "143022",                // 거래시간
    mchtTrdNo: "CARD20231215143022", // 주문번호
    mchtName: "테스트상점",
    mchtEName: "Test Shop",
    pmtPrdtNm: "테스트상품",
    trdAmt: "10000",                // 10,000원
    notiUrl: "https://yoursite.com/card/notify",
    nextUrl: "https://yoursite.com/card/success",
    cancUrl: "https://yoursite.com/card/cancel",
    pktHash: "생성된해시값",        // SHA256 해시
    ui: {
        type: "popup",
        width: "430",
        height: "660"
    }
}, function(response) {
    if (response.outStatCd === "0021") {
        // 결제 성공
        console.log("결제 성공:", response);
        location.href = response.nextUrl;
    } else {
        // 결제 실패
        console.log("결제 실패:", response.outRsltMsg);
        alert("결제가 실패했습니다: " + response.outRsltMsg);
    }
});
</script>
```

### 2️⃣ 테스트 정보

**테스트 환경에서 사용 가능한 카드 번호:**

| 카드사 | 카드번호 | 유효기간 | CVC |
|--------|----------|----------|-----|
| **신한카드** | `4000-0000-0000-0002` | `12/25` | `123` |
| **국민카드** | `4000-0000-0000-0010` | `12/25` | `123` |
| **삼성카드** | `4000-0000-0000-0028` | `12/25` | `123` |

---

## 🏗️ 구현 가이드

### 1️⃣ UI 결제창 연동

#### 📡 API 엔드포인트

| 환경 | URL |
|------|-----|
| **테스트** | `https://tbnpg.settlebank.co.kr/card/main.do` |
| **운영** | `https://npg.settlebank.co.kr/card/main.do` |

#### 📋 요청 파라미터

<ParameterCard
  name="mchtId"
  type="string(10)"
  required={true}
  description="헥토파이낸셜에서 부여하는 고유 상점아이디입니다. 결제 환경과 인증 방식에 따라 다른 값을 사용합니다."
  example="nxca_jt_il"
  values={[
    "nxca_jt_il: 인증 결제",
    "nxca_jt_bi: 비인증 결제", 
    "nxca_jt_gu: 구인증 결제",
    "nxca_ab_bi: 영문 외화 비인증",
    "nxca_ab_il: 영문 외화 인증"
  ]}
/>

<ParameterCard
  name="method"
  type="string(20)"
  required={true}
  description="PG 서비스에 해당하는 결제 구분 코드입니다."
  example="card"
  note="신용카드 결제의 경우 항상 'card' 고정값을 사용합니다."
/>

<ParameterCard
  name="trdDt"
  type="string(8)"
  required={true}
  description="거래 요청 일자입니다. yyyyMMdd 형식으로 전달합니다."
  example="20231215"
/>

<ParameterCard
  name="trdTm"
  type="string(6)"
  required={true}
  description="거래 요청 시간입니다. HH24MISS 형식으로 전달합니다."
  example="143022"
/>

<ParameterCard
  name="mchtTrdNo"
  type="string(100)"
  required={true}
  description="상점에서 생성하는 고유 주문번호입니다. 중복되지 않는 값이어야 하며, 결제 추적과 관리에 사용됩니다."
  example="CARD20231215143022"
  note="⚠️ 한글은 사용할 수 없으며, 영문, 숫자, 일부 특수문자만 사용 가능합니다."
/>

<ParameterCard
  name="mchtName"
  type="string(100)"
  required={true}
  description="상점의 한글명입니다. 결제창과 영수증에 표시됩니다."
  example="헥토파이낸셜"
/>

<ParameterCard
  name="mchtEName"
  type="string(100)"
  required={true}
  description="상점의 영문명입니다. 해외 카드 결제 시 사용됩니다."
  example="Hecto Financial"
/>

<ParameterCard
  name="pmtPrdtNm"
  type="string(128)"
  required={true}
  description="결제할 상품의 이름입니다. 고객에게 표시되는 상품명으로, 명확하게 작성해주세요."
  example="프리미엄 멤버십 1개월"
/>

<ParameterCard
  name="trdAmt"
  type="number(12)"
  required={true}
  description="거래금액입니다. 원화는 원 단위, USD는 센트 단위(100을 곱한 값)로 전달합니다."
  example="10000"
  note="⚠️ 이 필드는 AES 암호화가 필요합니다. USD 사용시 $1.00 → 100으로 전달하세요."
/>

<ParameterCard
  name="mchtCustNm"
  type="string(30)"
  required={false}
  description="결제하는 고객의 이름입니다. 신용카드 명의자와 일치하는 것이 좋습니다."
  example="홍길동"
  note="⚠️ 이 필드는 AES 암호화가 필요합니다."
/>

<ParameterCard
  name="notiUrl"
  type="string(250)"
  required={true}
  description="결제 완료 후 결과를 전달받을 서버 URL입니다. Server-to-Server 방식으로 결제 결과를 수신합니다."
  example="https://yoursite.com/payment/card/notification"
  note="💡 실제 결제 처리는 반드시 이 URL에서 처리하세요. 사용자가 브라우저를 닫아도 호출됩니다."
/>

<ParameterCard
  name="nextUrl"
  type="string(250)"
  required={true}
  description="결제 완료 후 고객에게 보여줄 화면 URL입니다. 결제 성공 시 이동할 페이지입니다."
  example="https://yoursite.com/payment/success"
  note="💡 화면 표시 용도로만 사용하고, 실제 결제 처리는 notiUrl에서 하세요."
/>

<ParameterCard
  name="cancUrl"
  type="string(250)"
  required={true}
  description="고객이 결제를 취소하거나 강제 종료했을 때 이동할 페이지 URL입니다."
  example="https://yoursite.com/payment/cancel"
/>

<ParameterCard
  name="mchtParam"
  type="string(4000)"
  required={false}
  description="상점에서 추가로 전달하고 싶은 정보를 담는 예약 필드입니다. 결제 완료 후 그대로 반환됩니다."
  example="userId=12345&productId=PROD001&couponCode=WELCOME10"
  note="💡 URL 인코딩된 쿼리스트링 형태로 전달하면 편리합니다."
/>

<ParameterCard
  name="email"
  type="string(60)"
  required={false}
  description="고객의 이메일 주소입니다. 결제 영수증 발송에 사용됩니다."
  example="customer@example.com"
  note="⚠️ 이 필드는 AES 암호화가 필요합니다."
/>

<ParameterCard
  name="instmtMon"
  type="string(2)"
  required={false}
  description="할부 개월 수입니다. 00은 일시불, 02&#126;24는 해당 개월 할부를 의미합니다."
  example="00"
  values={[
    "00: 일시불",
    "02: 2개월 할부",
    "03: 3개월 할부",
    "06: 6개월 할부",
    "12: 12개월 할부"
  ]}
  note="💡 빈 값으로 전달하면 고객이 결제창에서 선택할 수 있습니다."
/>

<ParameterCard
  name="cardType"
  type="string(1)"
  required={false}
  description="특정 카드 결제 방식을 지정할 때 사용합니다."
  values={[
    "3: 앱카드 전용 (신한/삼성/현대/KB/농협/롯데)",
    "6: 현대카드 PayShot (별도 계약 필요)"
  ]}
  note="💡 일반적으로는 비워두고, 특별한 요구사항이 있을 때만 사용하세요."
/>

<ParameterCard
  name="cardGb"
  type="string(4)"
  required={false}
  description="특정 카드사만 노출하고 싶을 때 사용하는 카드사 코드입니다."
  example="SHN"
  values={[
    "SHN: 신한카드만 노출",
    "KBC: 국민카드만 노출", 
    "SSC: 삼성카드만 노출"
  ]}
/>

<ParameterCard
  name="appScheme"
  type="string(100)"
  required={false}
  description="모바일 앱에서 결제 후 원래 앱으로 돌아가기 위한 스키마입니다."
  example="myapp://payment"
  note="💡 모바일 앱 개발 시에만 필요합니다. 웹에서는 사용하지 않습니다."
/>

<ParameterCard
  name="custIp"
  type="string(15)"
  required={false}
  description="실제 결제를 요청하는 고객의 IP 주소입니다. 보안 검증에 사용됩니다."
  example="192.168.1.100"
  note="⚠️ 서버 IP가 아닌 실제 고객(브라우저)의 IP를 전달해야 합니다."
/>

<ParameterCard
  name="pktHash"
  type="string(200)"
  required={true}
  description="위변조 방지를 위한 SHA256 해시값입니다. 지정된 순서로 파라미터를 조합하여 생성합니다."
  example="f395b6725a9a18f2563ce34f8bc76698051d27c05e5ba815f463f00429061c0c"
  note="🔒 상점아이디 + 결제수단 + 상점주문번호 + 요청일자 + 요청시간 + 거래금액(평문) + 해시키 순서로 조합"
/>

#### 🔐 해시 생성 예시

```javascript
const crypto = require('crypto');

function generateCardPaymentHash(params, hashKey) {
    // 해시 생성을 위한 데이터 조합
    const hashData = 
        params.mchtId +         // 상점아이디
        params.method +         // 결제수단 (card)
        params.mchtTrdNo +      // 상점주문번호
        params.trdDt +          // 요청일자
        params.trdTm +          // 요청시간
        params.trdAmt +         // 거래금액 (평문, 암호화 전)
        hashKey;                // 해시키 (헥토파이낸셜 제공)
    
    // SHA256 해시 생성
    return crypto.createHash('sha256').update(hashData, 'utf8').digest('hex');
}

// 사용 예시
const paymentParams = {
    mchtId: "nxca_jt_il",
    method: "card",
    mchtTrdNo: "CARD20231215143022",
    trdDt: "20231215",
    trdTm: "143022",
    trdAmt: "10000"  // 암호화 전 원본 금액
};

const hashKey = "your-hash-key-from-hecto"; // 헥토파이낸셜에서 제공
const pktHash = generateCardPaymentHash(paymentParams, hashKey);
```

### 2️⃣ 응답 처리

#### 📨 성공 응답 예시

```javascript
{
    "outStatCd": "0021",           // 성공 코드
    "outRsltCd": "0000",           // 결과 코드
    "outRsltMsg": "정상처리",       // 결과 메시지
    "method": "card",              // 결제수단
    "mchtTrdNo": "CARD20231215143022", // 상점주문번호
    "trdNo": "STFP_PGCAnxca_jt_il0231215143022M1234567", // 헥토 거래번호
    "trdAmt": "10000",             // 거래금액
    "authDt": "20231215143045",    // 승인일시
    "authNo": "12345678",          // 승인번호
    "intMon": "00",                // 할부개월 (00: 일시불)
    "fnNm": "신한카드",             // 카드사명
    "fnCd": "SHN",                 // 카드사코드
    "cardNo": "1234-56**-****-7890", // 마스킹된 카드번호
    "billKey": "SBILL_1234567890"  // 빌키 (정기결제용)
}
```

#### ❌ 실패 응답 예시

```javascript
{
    "outStatCd": "0031",           // 실패 코드
    "outRsltCd": "1009",           // 에러 코드
    "outRsltMsg": "결제 요청 정보 누락 (거래금액)", // 에러 메시지
    "method": "card",
    "mchtTrdNo": "CARD20231215143022"
}
```

### 3️⃣ 노티(NOTI) 처리

결제가 완료되면 `notiUrl`로 결과가 전송됩니다.

```javascript
// Node.js Express 예시
app.post('/payment/card/notification', (req, res) => {
    const {
        outStatCd,
        trdNo,
        method,
        mchtTrdNo,
        trdAmt,
        authNo,
        fnNm,
        pktHash
    } = req.body;
    
    // 1. 해시 검증
    const expectedHash = generateNotificationHash(req.body, hashKey);
    if (pktHash !== expectedHash) {
        console.error('해시 검증 실패');
        return res.status(400).send('FAIL');
    }
    
    // 2. 결제 성공 여부 확인
    if (outStatCd === '0021') {
        // 결제 성공 - DB 업데이트
        await updatePaymentStatus(mchtTrdNo, {
            status: 'completed',
            hectoTrdNo: trdNo,
            authNo: authNo,
            cardCompany: fnNm,
            amount: trdAmt
        });
        
        // 성공 응답
        res.send('OK');
    } else {
        // 결제 실패 처리
        await updatePaymentStatus(mchtTrdNo, {
            status: 'failed',
            errorMessage: req.body.outRsltMsg
        });
        
        res.send('OK');
    }
});
```

---

## 🔄 고급 기능

### 1️⃣ 정기결제 (빌키)

빌키를 이용한 정기결제 구현 방법입니다.

#### 📋 빌키 발급 요청

```javascript
// 첫 결제 시 빌키 발급 요청
SETTLE_PG.pay({
    // ... 기본 파라미터
    billKeyYn: "Y",        // 빌키 발급 요청
    // ... 나머지 파라미터
});
```

#### 🔄 빌키로 결제

```javascript
// 빌키를 이용한 정기결제 API 호출
const billingPayment = {
    params: {
        mchtId: "nxca_jt_il",
        ver: "0A19",
        mchtTrdNo: "BILLING20231215143022",
        trdDt: "20231215",
        trdTm: "143022"
    },
    data: {
        method: "CA",
        trdAmt: "10000",
        billKey: "SBILL_1234567890", // 이전에 발급받은 빌키
        pmtPrdtNm: "정기결제 상품",
        pktHash: "생성된해시값"
    }
};
```

### 2️⃣ 부분취소

결제 금액의 일부만 취소하는 기능입니다.

```javascript
const partialCancel = {
    params: {
        mchtId: "nxca_jt_il",
        ver: "0A19",
        mchtTrdNo: "CANCEL20231215143022",
        trdDt: "20231215",
        trdTm: "143022"
    },
    data: {
        method: "CA",
        orgTrdNo: "STFP_PGCAnxca_jt_il0231215143022M1234567", // 원거래번호
        orgTrdDt: "20231215",    // 원거래일자
        cnclAmt: "3000",         // 취소금액 (부분취소)
        cnclRsn: "고객 요청",     // 취소사유
        pktHash: "생성된해시값"
    }
};
```

### 3️⃣ WebView 연동 (모바일 앱)

모바일 앱에서 WebView를 통한 결제 연동 방법입니다.

#### Android 설정

```java
// WebView 설정
WebView webView = findViewById(R.id.webview);
WebSettings webSettings = webView.getSettings();
webSettings.setJavaScriptEnabled(true);
webSettings.setDomStorageEnabled(true);

// 결제 완료 후 앱으로 복귀
webView.setWebViewClient(new WebViewClient() {
    @Override
    public boolean shouldOverrideUrlLoading(WebView view, String url) {
        if (url.startsWith("myapp://")) {
            // 앱 스키마 처리
            Intent intent = new Intent(Intent.ACTION_VIEW, Uri.parse(url));
            startActivity(intent);
            return true;
        }
        return false;
    }
});
```

#### iOS 설정

```swift
// WKWebView 설정
import WebKit

class PaymentViewController: UIViewController, WKNavigationDelegate {
    @IBOutlet weak var webView: WKWebView!
    
    override func viewDidLoad() {
        super.viewDidLoad()
        webView.navigationDelegate = self
        
        // 결제 페이지 로드
        if let url = URL(string: paymentUrl) {
            webView.load(URLRequest(url: url))
        }
    }
    
    func webView(_ webView: WKWebView, decidePolicyFor navigationAction: WKNavigationAction, decisionHandler: @escaping (WKNavigationActionPolicy) -> Void) {
        
        if let url = navigationAction.request.url?.absoluteString {
            if url.hasPrefix("myapp://") {
                // 앱 스키마 처리
                decisionHandler(.cancel)
                return
            }
        }
        decisionHandler(.allow)
    }
}
```

---

## 🧪 테스트 가이드

### 🔧 테스트 환경 설정

**테스트 상점 정보:**
- **상점ID**: `nxca_jt_il` (인증), `nxca_jt_bi` (비인증)
- **환경**: `https://tbnpg.settlebank.co.kr`
- **특징**: 실제 결제 없이 승인 테스트 가능

### 💳 테스트 카드 정보

| 카드사 | 카드번호 | 유효기간 | CVC | 비밀번호 |
|--------|----------|----------|-----|----------|
| **신한카드** | `4000-0000-0000-0002` | `12/25` | `123` | `00` |
| **국민카드** | `4000-0000-0000-0010` | `12/25` | `123` | `00` |
| **삼성카드** | `4000-0000-0000-0028` | `12/25` | `123` | `00` |
| **현대카드** | `4000-0000-0000-0036` | `12/25` | `123` | `00` |
| **하나카드** | `4000-0000-0000-0044` | `12/25` | `123` | `00` |

### 🎯 테스트 시나리오

<TestScenario 
  successItems={[
    "정상 카드번호로 일시불 결제",
    "할부 결제 (2, 3, 6, 12개월)",
    "빌키 발급 후 정기결제",
    "부분취소 및 전체취소"
  ]}
  failureItems={[
    "잘못된 카드번호",
    "만료된 카드",
    "한도 초과",
    "해시값 불일치"
  ]}
/>

---

## ❌ 에러 처리

### 🚨 주요 에러 코드

| 코드 | 메시지 | 원인 | 해결방법 |
|------|--------|------|----------|
| `1009` | 결제 요청 정보 누락 (거래금액) | 필수 파라미터 누락 | 필수 파라미터 확인 |
| `1901` | 해쉬값 불일치 오류 | 해시 생성 오류 | 해시 생성 로직 점검 |
| `1902` | 암호화 항목 미처리 오류 | 암호화 필드 미처리 | AES 암호화 적용 |
| `ST47` | 미등록 상점 | 잘못된 상점ID | 올바른 상점ID 사용 |
| `ST50` | 중복요청 | 동일한 주문번호 재사용 | 고유한 주문번호 생성 |

### 🔧 에러 해결 가이드

<ErrorGuide 
  title="일반적인 문제 해결"
  content={
    <ul className="mt-2 text-yellow-700 text-sm space-y-1">
      <li>• <strong>해시 오류</strong>: 파라미터 순서와 인코딩 확인</li>
      <li>• <strong>암호화 오류</strong>: AES-128-ECB 방식과 키 확인</li>
      <li>• <strong>중복 주문번호</strong>: 타임스탬프나 UUID 활용</li>
      <li>• <strong>금액 오류</strong>: 숫자 형태와 암호화 여부 확인</li>
    </ul>
  }
/>

---

## 💡 자주 묻는 질문

### Q. 해외 카드도 결제 가능한가요?
A. 네, 외화 결제 전용 상점ID(`nxca_ab_bi`, `nxca_ab_il`)를 사용하면 해외 카드 결제가 가능합니다.

### Q. 빌키의 유효기간은 얼마나 되나요?
A. 빌키는 카드 유효기간과 동일하며, 카드가 재발급되면 새로운 빌키를 발급받아야 합니다.

### Q. 할부 수수료는 누가 부담하나요?
A. 일반적으로 고객이 부담하지만, 가맹점이 무이자 할부로 제공할 수도 있습니다.

### Q. 부분취소는 몇 번까지 가능한가요?
A. 원거래 금액 범위 내에서 여러 번 부분취소가 가능합니다.

---

## 🚀 다음 단계

<NextSteps 
  title="신용카드 결제 연동을 완료했다면, 다른 결제 수단도 확인해보세요:"
  steps={[
    {
      href: "/docs/pg/virtual-account",
      icon: "💰",
      title: "가상계좌",
      bgColor: "bg-white",
      borderColor: "border-green-100",
      hoverBorderColor: "border-green-300",
      iconBgColor: "bg-green-500",
      hoverIconBgColor: "bg-green-600"
    },
    {
      href: "/docs/pg/bank-transfer",
      icon: "🏦",
      title: "계좌이체",
      bgColor: "bg-white",
      borderColor: "border-blue-100",
      hoverBorderColor: "border-blue-300",
      iconBgColor: "bg-blue-500",
      hoverIconBgColor: "bg-blue-600"
    },
    {
      href: "/docs/pg/mobile-payment",
      icon: "📱",
      title: "휴대폰",
      bgColor: "bg-white",
      borderColor: "border-purple-100",
      hoverBorderColor: "border-purple-300",
      iconBgColor: "bg-purple-500",
      hoverIconBgColor: "bg-purple-600"
    },
    {
      href: "/docs/pg/simple-payment",
      icon: "⚡",
      title: "간편결제",
      bgColor: "bg-white",
      borderColor: "border-orange-100",
      hoverBorderColor: "border-orange-300",
      iconBgColor: "bg-orange-500",
      hoverIconBgColor: "bg-orange-600"
    }
  ]}
/>

---

<DocumentFooter 
  title="신용카드 결제 연동에 대한 추가 문의사항이 있으시나요?"
  primaryButton={{
    text: "📧 기술지원 문의",
    href: "mailto:support@hectofinancial.com",
    bgColor: "bg-hecto-400",
    hoverBgColor: "hover:bg-hecto-500"
  }}
  secondaryButton={{
    text: "📚 API 레퍼런스",
    href: "/docs/pg/api-reference"
  }}
/>
